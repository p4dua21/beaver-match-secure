<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Beaver Match Pro v4.4 | AI Lender Matching Engine</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass-card { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.9); }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .shadow-soft { box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08); }
    .shadow-deep { box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); }
    .form-section { 
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.5s ease-in-out;
    }
    .form-section.active {
      opacity: 1;
      max-height: 5000px;
      margin-bottom: 1.5rem;
    }
    .step-indicator {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: bold;
      margin-right: 10px;
    }
    .score-badge {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #1a1a1a;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      font-size: 0.85rem;
    }
    .excluded-card {
      background: linear-gradient(145deg, #fef2f2, #fee2e2);
      border-left: 4px solid #ef4444;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // ---------- COLUMN MAPPING (spreadsheet → your new headers) ----------
    const COLUMN_MAP = {
      'Finance_Category': 'Finance_Category',
      'Min_Loan': 'Min_Loan',
      'Max_Loan': 'Max_Loan',
      'Max_Loan_Length': 'Max_Loan_Length',
      'Min_GST_Mths': 'Min_GST_Mths',
      'Min_ABN_Mths': 'Min_ABN_Mths',
      'Min_Turnover_PM': 'Min_Turnover_PM',
      'CCR_Score': 'CCR_Score',
      'Min_Equifax_Score': 'Min_Equifax_Score',
      'Veda_Score': 'Veda_Score',
      'If_Asset_Backed': 'If_Asset_Backed',
      'If_Non_Asset_Backed': 'If_Non_Asset_Backed',
      'Need_Bank_Stmts': 'Need_Bank_Stmts',
      'Months_Bank_Stmts_Req': 'Months_Bank_Stmts_Req',
      'Need_ATO': 'Need_ATO',
      'Max_Asset_Age_EOT': 'Max_Asset_Age_EOT_Months',
      'Need_Homeowner': 'Need_Homeowner',
      'Residential_Required': 'Residential_Required',
      'Age_Asset_Limit': 'Age_Asset_Limit_Months',
      'Balloon_Max': 'Balloon_Max',
      'Comparable_Credit': 'Comparable_Credit',
      'Asset_Car': 'Asset_Car',
      'Asset_Truck': 'Asset_Truck',
      'Asset_Trailer': 'Asset_Trailer',
      'Asset_Equipment': 'Asset_Equipment',
      'Asset_PrimeMover': 'Asset_PrimeMover',
      'Asset_Other': 'Asset_Other',
      'Private_Sale_OK': 'Private_Sale_OK',
      'Refinance_OK': 'Refinance_OK',
      'Max_Dishonours_90D': 'Max_Dishonours_90D',
      'Payday_OK': 'Payday_OK',
      'Min_Income_PM': 'Min_Income_PM',
      'Max_LVR': 'Max_LVR',
      'Related_Party_OK': 'Related_Party_OK',
      '%_Deposit (Non-Asset)': '_Deposit (Non-Asset)',
      'Max_Brokerage_%': 'Max_Brokerage_%',
      'Max_Brokerage_Fee': 'Max_Broker_Fee',
      'Standard_Interest_Rate_Avg': 'Standard_Interest_Rate_Avg',
      'Lender_Name': 'Lender_Name',
      'Product': 'Product',
      'Special_Notes': 'Special_Notes'
    };

    function LenderMatchingApp() {
      const [formData, setFormData] = useState({
        financeCategory: "",
        loanAmount: "",
        creditScoreType: "N/A",
        creditScoreComprehensive: "",
        creditScoreVeda: "",
        ccrScore: "",
        entityType: "PtyLtd",
        abnAge: "No",
        gstAge: "No",
        businessTurnoverPM: "",
        provideATODocuments: "No",
        assetType: "Asset_Car",
        assetAge: "0",
        assetValue: "",
        privateSale: "No",
        refinance: "No",
        loanTerm: "60",
        balloonPercent: "0",
        depositPercent: "0",
        residentialProof: "No",
        isHomeOwner: "No",
        isAssetBacked: "No",
        provideBankStatements: "Yes",
        bankStatementsMonths: "3",
        comparableCredit: "No",
        dishonoursLast90D: "0",
        hasPaydayLoans: "No",
        monthlyIncome: "",
        employmentType: "Full-time"
      });

      const [lenders, setLenders] = useState([]);
      const [results, setResults] = useState(null);
      const [excludedResults, setExcludedResults] = useState(null);
      const [showExcluded, setShowExcluded] = useState(false);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [activeStep, setActiveStep] = useState(1);

      useEffect(() => {
        loadSheets();
      }, []);

      async function loadSheets() {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch('/api/get-lenders');
          if (!response.ok) throw new Error(`Server returned ${response.status}: ${response.statusText}`);
          const data = await response.json();
          if (data.error) throw new Error(data.error);
          if (!data.values || data.values.length === 0) throw new Error("No data returned from server");

          const headers = data.values[0];
          const parsed = [];

          for (let i = 1; i < data.values.length; i++) {
            const row = data.values[i];
            let obj = {};
            headers.forEach((header, idx) => {
              if (header && header.trim()) {
                const originalKey = header.trim();
                const newKey = COLUMN_MAP[originalKey] || originalKey;
                obj[newKey] = (row[idx] || '').toString().trim();
              }
            });
            if (obj.Lender_Name && obj.Lender_Name.length > 0) {
              parsed.push(obj);
            }
          }

          setLenders(parsed);
        } catch (err) {
          console.error("Load error:", err);
          setError(err.message);
        }
        setLoading(false);
      }

      const resetForm = () => {
        setFormData({
          financeCategory: "",
          loanAmount: "",
          creditScoreType: "N/A",
          creditScoreComprehensive: "",
          creditScoreVeda: "",
          ccrScore: "",
          entityType: "PtyLtd",
          abnAge: "No",
          gstAge: "No",
          businessTurnoverPM: "",
          provideATODocuments: "No",
          assetType: "Asset_Car",
          assetAge: "0",
          assetValue: "",
          privateSale: "No",
          refinance: "No",
          loanTerm: "60",
          balloonPercent: "0",
          depositPercent: "0",
          residentialProof: "No",
          isHomeOwner: "No",
          isAssetBacked: "No",
          provideBankStatements: "Yes",
          bankStatementsMonths: "3",
          comparableCredit: "No",
          dishonoursLast90D: "0",
          hasPaydayLoans: "No",
          monthlyIncome: "",
          employmentType: "Full-time"
        });
        setResults(null);
        setExcludedResults(null);
        setShowExcluded(false);
        setActiveStep(1);
      };

      // ---------- PARSING HELPERS ----------
      function parseRequirement(requirementText, isYesNo = false) {
        if (!requirementText) return null;
        const text = requirementText.toString().toLowerCase().trim();
        if (isYesNo) {
          if (text === "yes" || text === "y" || text === "true") return "Yes";
          if (text === "no" || text === "n" || text === "false") return "No";
          return null;
        }
        if (text.includes("+")) {
          const min = parseInt(text);
          return { min: min, max: null };
        }
        if (text.includes("-")) {
          const parts = text.split("-").map(p => parseInt(p.trim()));
          if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
            return { min: parts[0], max: parts[1] };
          }
        }
        const num = parseInt(text);
        if (!isNaN(num)) return num;
        return text;
      }

      function meetsRequirement(value, requirement, greaterIsBetter = true) {
        if (!requirement) return true;
        if (typeof requirement === "string") return value === requirement;
        if (typeof requirement === "number") {
          if (greaterIsBetter) return parseFloat(value) >= requirement;
          else return parseFloat(value) <= requirement;
        }
        if (typeof requirement === "object" && requirement !== null) {
          const val = parseFloat(value);
          if (isNaN(val)) return false;
          let meetsMin = true, meetsMax = true;
          if (requirement.min !== null && requirement.min !== undefined) meetsMin = val >= requirement.min;
          if (requirement.max !== null && requirement.max !== undefined) meetsMax = val <= requirement.max;
          return meetsMin && meetsMax;
        }
        return true;
      }

      // ----- Parse ABN months from dropdown -----
      function parseABNMonths(abnSelection) {
        const mapping = {
          "No": 0,
          "New-3 months": 0,
          "3-6 months": 3,
          "6-12 months": 6,
          "12-18 months": 12,
          "18-24 months": 18,
          "24 months +": 24
        };
        return mapping[abnSelection] || 0;
      }

      // ----- Parse GST months from dropdown -----
      function parseGSTMonths(gstSelection) {
        const mapping = {
          "No": 0,
          "New-3 months": 0,
          "3-6 months": 3,
          "6-12 months": 6,
          "12-18 months": 12,
          "18-24 months": 18,
          "24 months +": 24
        };
        return mapping[gstSelection] || 0;
      }

      function parseDepositRequirement(depositColumnText) {
        if (!depositColumnText) return { minDepositPercent: 0, disqualified: false, note: "" };
        const text = depositColumnText.toString().toLowerCase();
        if (text.includes("doesn't qualify") || text.includes("doesnt qualify") || text.includes("no finance")) {
          return { minDepositPercent: null, disqualified: true, note: "Doesn't qualify for non-asset backed" };
        }
        const percentageMatch = text.match(/(\d+(?:\.\d+)?)%/);
        if (percentageMatch) {
          const depositPercent = parseFloat(percentageMatch[1]);
          return { minDepositPercent: depositPercent, disqualified: false, note: `${depositPercent}% deposit required for non-asset backed` };
        }
        const num = parseFloat(text);
        if (!isNaN(num)) return { minDepositPercent: num, disqualified: false, note: `${num}% deposit required` };
        return { minDepositPercent: 0, disqualified: false, note: "" };
      }

      function calculateLVR(loanAmount, assetValue) {
        if (!loanAmount || !assetValue) return 0;
        const loan = parseFloat(loanAmount);
        const value = parseFloat(assetValue);
        if (value === 0) return 0;
        return (loan / value) * 100;
      }

      function acceptsAssetType(lender, assetType) {
        const assetColumns = {
          "Asset_Car": "Asset_Car",
          "Asset_Truck": "Asset_Truck",
          "Asset_Trailer": "Asset_Trailer",
          "Asset_Equipment": "Asset_Equipment",
          "Asset_PrimeMover": "Asset_PrimeMover",
          "Asset_Other": "Asset_Other"
        };
        const column = assetColumns[assetType];
        if (!column) return true;
        const acceptance = lender[column];
        return acceptance === "Yes" || acceptance === "TRUE" || acceptance === "Y" || acceptance === true;
      }

      function calculateTotalBrokerageFee(lender, loanAmount) {
        if (!loanAmount) return 0;
        const loanAmt = parseFloat(loanAmount);
        const maxPercent = parseFloat(lender['Max_Brokerage_%']) || 0;
        const maxFee = parseFloat(lender['Max_Broker_Fee']) || 0;
        const percentFee = loanAmt * (maxPercent / 100);
        return percentFee + maxFee;
      }

      // ---------- UPDATED SCORING (v4.4) ----------
      // Weights: Interest 50%, Brokerage % 40%, Broker Fee 10%
      function calculateScore(lender, loanAmount) {
        const weights = { 
          interest: 0.50, 
          brokeragePct: 0.40, 
          brokerFee: 0.10 
        };

        // 1. Interest rate (lower is better) – assume 5% to 30% range
        let interest = parseFloat(lender['Standard_Interest_Rate_Avg']);
        if (isNaN(interest)) interest = 20.0; // worst case
        const interestScore = Math.max(0, Math.min(100, 
          100 - ((interest - 5) / (30 - 5) * 100)
        ));

        // 2. Brokerage % (higher is better) – assume 0% to 10% range
        let brokerPct = parseFloat(lender['Max_Brokerage_%']);
        if (isNaN(brokerPct)) brokerPct = 0;
        const brokerPctScore = Math.max(0, Math.min(100, 
          (brokerPct / 10) * 100
        ));

        // 3. Max broker fee (lower is better) – assume $0 to $2000 range
        let fee = parseFloat(lender['Max_Broker_Fee']);
        if (isNaN(fee)) fee = 2000;
        const feeScore = Math.max(0, Math.min(100, 
          100 - (fee / 2000 * 100)
        ));

        // Weighted sum (weights already sum to 1.0)
        const totalScore = 
          interestScore * weights.interest +
          brokerPctScore * weights.brokeragePct +
          feeScore * weights.brokerFee;

        return Math.round(totalScore);
      }

      const update = (f, v) => setFormData(p => ({ ...p, [f]: v }));
      const handleFinanceCategorySelect = (category) => {
        update("financeCategory", category);
        setActiveStep(2);
      };
      const shouldShowBusinessSection = () => formData.financeCategory === "Commercial Asset" || formData.financeCategory === "Commercial Cash Finance";
      const shouldShowConsumerSection = () => formData.financeCategory === "Consumer";

      // ---------- HARD STOP CHECKS (unchanged, with 24-month capping) ----------
      function calculateMatch() {
        if (!formData.loanAmount) { alert("Please enter a loan amount"); return; }
        if (!formData.financeCategory) { alert("Please select a finance category"); return; }

        const evaluated = lenders.map(l => {
          let isExcluded = false;
          let exclusionReasons = [];
          let depositNote = "";

          const loanAmt = parseFloat(formData.loanAmount);
          const loanTermMonths = parseInt(formData.loanTerm);
          const balloonPct = parseFloat(formData.balloonPercent);
          const userDeposit = parseFloat(formData.depositPercent) || 0;
          const assetAge = formData.assetAge === "15+" ? 16 : parseInt(formData.assetAge);
          const abnMonths = parseABNMonths(formData.abnAge);
          const gstMonths = parseGSTMonths(formData.gstAge);
          const monthlyIncome = parseFloat(formData.monthlyIncome) || 0;
          const assetValue = parseFloat(formData.assetValue) || 0;
          const lvr = calculateLVR(formData.loanAmount, assetValue);
          
          // 1. Finance Category
          if (l.Finance_Category && l.Finance_Category !== formData.financeCategory) {
            isExcluded = true;
            exclusionReasons.push(`Finance Category mismatch (required: ${l.Finance_Category})`);
          }

          // 2. Loan Amount Range
          if (l.Min_Loan && loanAmt < parseFloat(l.Min_Loan)) {
            isExcluded = true;
            exclusionReasons.push(`Loan amount below minimum (${l.Min_Loan})`);
          }
          if (l.Max_Loan && loanAmt > parseFloat(l.Max_Loan)) {
            isExcluded = true;
            exclusionReasons.push(`Loan amount above maximum (${l.Max_Loan})`);
          }

          // 3. Loan Term (Max_Loan_Length)
          if (l.Max_Loan_Length) {
            const lenderTerm = parseFloat(l.Max_Loan_Length);
            if (loanTermMonths > lenderTerm) {
              isExcluded = true;
              exclusionReasons.push(`Loan term exceeds maximum (${lenderTerm} months)`);
            }
          }

          // 4. ABN Age – cap lender requirement at 24 months
          if (shouldShowBusinessSection() && l.Min_ABN_Mths && l.Min_ABN_Mths !== "NA") {
            let minABN = parseFloat(l.Min_ABN_Mths);
            if (minABN > 24) minABN = 24;
            if (abnMonths < minABN) {
              isExcluded = true;
              exclusionReasons.push(`ABN age requirement (${l.Min_ABN_Mths} months, capped at 24)`);
            }
          }

          // 5. GST Age – cap lender requirement at 24 months
          if (shouldShowBusinessSection() && l.Min_GST_Mths && l.Min_GST_Mths !== "NA" && formData.gstAge !== "No") {
            let minGST = parseFloat(l.Min_GST_Mths);
            if (minGST > 24) minGST = 24;
            if (gstMonths < minGST) {
              isExcluded = true;
              exclusionReasons.push(`GST registration age requirement (${l.Min_GST_Mths} months, capped at 24)`);
            }
          }

          // 6. Turnover
          if (shouldShowBusinessSection() && l.Min_Turnover_PM && l.Min_Turnover_PM !== "NA") {
            const minTurnover = parseFloat(l.Min_Turnover_PM);
            const userTurnover = parseFloat(formData.businessTurnoverPM) || 0;
            if (userTurnover < minTurnover) {
              isExcluded = true;
              exclusionReasons.push(`Minimum turnover (${minTurnover} per month)`);
            }
          }

          // 7. Credit Scores
          if (l.CCR_Score && l.CCR_Score !== "NA") {
            const ccrReq = parseRequirement(l.CCR_Score);
            const userCCR = parseFloat(formData.ccrScore) || 0;
            if (!meetsRequirement(userCCR, ccrReq)) {
              isExcluded = true;
              exclusionReasons.push(`CCR Score requirement (${l.CCR_Score})`);
            }
          }
          if (l.Min_Equifax_Score && l.Min_Equifax_Score !== "NA") {
            const eqReq = parseRequirement(l.Min_Equifax_Score);
            const userEq = parseFloat(formData.creditScoreComprehensive) || 0;
            if (!meetsRequirement(userEq, eqReq)) {
              isExcluded = true;
              exclusionReasons.push(`Equifax Score requirement (${l.Min_Equifax_Score})`);
            }
          }
          if (l.Veda_Score && l.Veda_Score !== "NA") {
            const vedaReq = parseRequirement(l.Veda_Score);
            const userVeda = parseFloat(formData.creditScoreVeda) || 0;
            if (!meetsRequirement(userVeda, vedaReq)) {
              isExcluded = true;
              exclusionReasons.push(`Veda Score requirement (${l.Veda_Score})`);
            }
          }

          // 8. Asset/Non‑Asset Backed
          if (formData.isAssetBacked === "Yes" && l.If_Asset_Backed === "No") {
            isExcluded = true;
            exclusionReasons.push(`Does not accept asset-backed loans`);
          }
          if (formData.isAssetBacked === "No" && l.If_Non_Asset_Backed === "No") {
            isExcluded = true;
            exclusionReasons.push(`Does not accept non-asset backed loans`);
          }

          // 9. Bank Statements
          if (l.Need_Bank_Stmts && parseRequirement(l.Need_Bank_Stmts, true) === "Yes") {
            if (formData.provideBankStatements !== "Yes") {
              isExcluded = true;
              exclusionReasons.push(`Bank statements required`);
            } else if (l.Months_Bank_Stmts_Req) {
              const reqMonths = parseFloat(l.Months_Bank_Stmts_Req);
              const userMonths = parseFloat(formData.bankStatementsMonths) || 0;
              if (userMonths < reqMonths) {
                isExcluded = true;
                exclusionReasons.push(`Insufficient bank statements (${reqMonths} months required)`);
              }
            }
          }

          // 10. ATO Documents
          if (shouldShowBusinessSection() && l.Need_ATO && parseRequirement(l.Need_ATO, true) === "Yes") {
            if (formData.provideATODocuments !== "Yes") {
              isExcluded = true;
              exclusionReasons.push(`ATO documents required`);
            }
          }

          // 11. Asset Age at End of Term
          if (l.Max_Asset_Age_EOT_Months) {
            const maxEOT = parseFloat(l.Max_Asset_Age_EOT_Months);
            const assetAgeAtEOT = assetAge + (loanTermMonths / 12);
            if (assetAgeAtEOT > maxEOT) {
              isExcluded = true;
              exclusionReasons.push(`Asset age at end of term (${maxEOT} years max)`);
            }
          }

          // 12. Age Asset Limit (start of term)
          if (l.Age_Asset_Limit_Months) {
            const ageLimit = parseFloat(l.Age_Asset_Limit_Months);
            if (assetAge > ageLimit) {
              isExcluded = true;
              exclusionReasons.push(`Asset age limit (${ageLimit} years max)`);
            }
          }

          // 13. Homeowner
          if (l.Need_Homeowner && parseRequirement(l.Need_Homeowner, true) === "Yes") {
            if (formData.isHomeOwner !== "Yes") {
              isExcluded = true;
              exclusionReasons.push(`Homeowner required`);
            }
          }

          // 14. Residential Proof
          if (l.Residential_Required && l.Residential_Required !== "No") {
            const userMonths = {
              "No": 0,
              "6 months": 6,
              "12 months": 12,
              "24 months +": 24
            }[formData.residentialProof] || 0;
            let requiredMonths = 0;
            const req = l.Residential_Required.toString().toLowerCase();
            if (req.includes("24") || req.includes("2 year")) requiredMonths = 24;
            else if (req.includes("12") || req.includes("1 year")) requiredMonths = 12;
            else if (req.includes("6") || req.includes("6 month")) requiredMonths = 6;
            else if (req === "yes" || req === "required") requiredMonths = 6;
            if (userMonths < requiredMonths) {
              isExcluded = true;
              exclusionReasons.push(`Residential proof (${requiredMonths} months required)`);
            }
          }

          // 15. Balloon
          if (l.Balloon_Max && balloonPct > parseFloat(l.Balloon_Max)) {
            isExcluded = true;
            exclusionReasons.push(`Balloon payment exceeds maximum (${l.Balloon_Max}%)`);
          }

          // 16. Comparable Credit
          if (l.Comparable_Credit && parseRequirement(l.Comparable_Credit, true) === "Yes") {
            if (formData.comparableCredit !== "Yes") {
              isExcluded = true;
              exclusionReasons.push(`Comparable credit history required`);
            }
          }

          // 17. Asset Type
          if (!acceptsAssetType(l, formData.assetType)) {
            isExcluded = true;
            exclusionReasons.push(`Does not accept ${formData.assetType.replace('_', ' ')}`);
          }

          // 18. Private Sale
          if (l.Private_Sale_OK && parseRequirement(l.Private_Sale_OK, true) === "No") {
            if (formData.privateSale === "Yes") {
              isExcluded = true;
              exclusionReasons.push(`Private sale not accepted`);
            }
          }

          // 19. Refinance
          if (l.Refinance_OK && parseRequirement(l.Refinance_OK, true) === "No") {
            if (formData.refinance === "Yes") {
              isExcluded = true;
              exclusionReasons.push(`Refinance not accepted`);
            }
          }

          // 20. Dishonours
          if (l.Max_Dishonours_90D && l.Max_Dishonours_90D !== "NA") {
            const maxDishonours = parseFloat(l.Max_Dishonours_90D);
            const userDishonours = parseFloat(formData.dishonoursLast90D) || 0;
            if (userDishonours > maxDishonours) {
              isExcluded = true;
              exclusionReasons.push(`Too many dishonours (${maxDishonours} max in 90 days)`);
            }
          }

          // 21. Payday Loans
          if (l.Payday_OK && parseRequirement(l.Payday_OK, true) === "No") {
            if (formData.hasPaydayLoans === "Yes") {
              isExcluded = true;
              exclusionReasons.push(`Payday loans not accepted`);
            }
          }

          // 22. Minimum Income
          if (shouldShowConsumerSection() && l.Min_Income_PM && l.Min_Income_PM !== "NA") {
            const minIncome = parseFloat(l.Min_Income_PM);
            if (monthlyIncome < minIncome) {
              isExcluded = true;
              exclusionReasons.push(`Minimum income requirement (${minIncome} per month)`);
            }
          }

          // 23. Max LVR
          if (l.Max_LVR && l.Max_LVR !== "NA") {
            const maxLVR = parseFloat(l.Max_LVR);
            if (lvr > maxLVR) {
              isExcluded = true;
              exclusionReasons.push(`LVR too high (${maxLVR}% max)`);
            }
          }

          // 24. Deposit for Non-Asset Backed (this is a HARD STOP, not used in scoring)
          if (l.If_Non_Asset_Backed && formData.isAssetBacked === "No") {
            const depositRequirement = parseDepositRequirement(l['_Deposit (Non-Asset)']);
            if (depositRequirement.disqualified) {
              isExcluded = true;
              exclusionReasons.push("Doesn't qualify for non-asset backed");
            } else if (depositRequirement.minDepositPercent !== null) {
              if (userDeposit < depositRequirement.minDepositPercent) {
                isExcluded = true;
                exclusionReasons.push(`Requires ${depositRequirement.minDepositPercent}% deposit for non-asset backed`);
              } else if (depositRequirement.note) {
                depositNote = depositRequirement.note;
              }
            }
          }

          const score = !isExcluded ? calculateScore(l, formData.loanAmount) : 0;
          const totalBrokerageFee = !isExcluded ? calculateTotalBrokerageFee(l, formData.loanAmount) : 0;

          return { ...l, isExcluded, exclusionReasons, depositNote, totalBrokerageFee, score };
        });

        const included = evaluated.filter(l => !l.isExcluded).sort((a,b) => b.score - a.score);
        const excluded = evaluated.filter(l => l.isExcluded);

        setResults(included);
        setExcludedResults(excluded);
        setShowExcluded(false);
      }

      // ---------- RENDER (unchanged except version text) ----------
      return (
        <div className="min-h-screen">
          {/* Header */}
          <header className="gradient-bg text-white shadow-deep">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
              <div className="flex flex-col md:flex-row justify-between items-center">
                <div className="flex items-center space-x-4 mb-4 md:mb-0">
                  <div className="bg-white p-3 rounded-xl shadow-soft">
                    <i className="fas fa-piggy-bank text-2xl text-purple-600"></i>
                  </div>
                  <div>
                    <h1 className="text-3xl font-bold tracking-tight">Beaver Match Pro v4.4</h1>
                    <p className="text-blue-100 font-medium"> AI Matching System</p>
                  </div>
                </div>
                <div className="flex items-center space-x-4">
                  <div className="text-center bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                    <div className="text-sm text-blue-100">Available Lenders</div>
                    <div className="text-2xl font-bold">{lenders.length}</div>
                  </div>
                  <button 
                    onClick={loadSheets}
                    className="bg-white text-purple-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-all flex items-center"
                  >
                    <i className="fas fa-sync-alt mr-2"></i>Refresh
                  </button>
                </div>
              </div>
            </div>
          </header>

          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            {/* Progress Steps */}
            <div className="mb-8">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center">
                  <div className={`step-indicator ${activeStep >= 1 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>1</div>
                  <div><h3 className="font-bold text-gray-800">Select Finance Category</h3><p className="text-sm text-gray-600">Mandatory first step</p></div>
                </div>
                <div className="flex-1 mx-4"><div className="h-1 bg-gray-200"><div className="h-1 bg-blue-600 transition-all duration-300" style={{ width: activeStep >= 2 ? '100%' : '0%' }}></div></div></div>
                <div className="flex items-center">
                  <div className={`step-indicator ${activeStep >= 2 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>2</div>
                  <div><h3 className="font-bold text-gray-800">Complete Details</h3><p className="text-sm text-gray-600">All required information</p></div>
                </div>
              </div>
            </div>

            {/* Main Content - Form and Sidebar (identical to previous version) */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              {/* Form Section */}
              <div className="lg:col-span-2">
                <div className="bg-white rounded-2xl shadow-deep overflow-hidden">
                  <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <h2 className="text-2xl font-bold text-white">Client Profile Setup</h2>
                        <p className="text-blue-100">
                          {!formData.financeCategory 
                            ? "Step 1: Select finance category" 
                            : `Step 2: Complete ${formData.financeCategory} details`}
                        </p>
                      </div>
                      <div className="bg-white/20 p-3 rounded-full">
                        <i className="fas fa-user-tie text-white text-2xl"></i>
                      </div>
                    </div>
                  </div>
                  
                  <div className="p-6">
                    {error && (
                      <div className="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <div className="flex items-center">
                          <i className="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i>
                          <div>
                            <p className="font-bold text-red-800">Connection Error</p>
                            <p className="text-red-700 text-sm">{error}</p>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {/* STEP 1: Finance Category Selection */}
                    {!formData.financeCategory && (
                      <div className="py-8">
                        <div className="text-center mb-8">
                          <div className="inline-block bg-blue-100 p-4 rounded-full mb-4">
                            <i className="fas fa-layer-group text-4xl text-blue-600"></i>
                          </div>
                          <h3 className="text-2xl font-bold text-gray-800 mb-2">Select Finance Category</h3>
                          <p className="text-gray-600 max-w-2xl mx-auto">
                            Choose the type of finance you're looking for. This will determine which questions you need to answer.
                          </p>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                          {/* Commercial Asset */}
                          <button 
                            onClick={() => handleFinanceCategorySelect("Commercial Asset")}
                            className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-2xl p-6 text-center hover:border-blue-400 hover:shadow-lg transition-all duration-300 group"
                          >
                            <div className="inline-block bg-blue-500 p-4 rounded-full mb-4 group-hover:bg-blue-600 transition-all">
                              <i className="fas fa-truck-loading text-2xl text-white"></i>
                            </div>
                            <h4 className="text-xl font-bold text-gray-800 mb-2">Commercial Asset</h4>
                            <p className="text-gray-600 text-sm mb-4">
                              Business loans secured by vehicles, equipment, or other business assets
                            </p>
                            <div className="text-left mt-4">
                              <p className="text-sm text-gray-700 mb-1"><i className="fas fa-check-circle text-green-500 mr-2"></i> Business entities (Pty Ltd, Sole Trader)</p>
                              <p className="text-sm text-gray-700 mb-1"><i className="fas fa-check-circle text-green-500 mr-2"></i> ABN & GST requirements</p>
                              <p className="text-sm text-gray-700"><i className="fas fa-check-circle text-green-500 mr-2"></i> Asset security required</p>
                            </div>
                          </button>
                          
                          {/* Consumer */}
                          <button 
                            onClick={() => handleFinanceCategorySelect("Consumer")}
                            className="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-200 rounded-2xl p-6 text-center hover:border-purple-400 hover:shadow-lg transition-all duration-300 group"
                          >
                            <div className="inline-block bg-purple-500 p-4 rounded-full mb-4 group-hover:bg-purple-600 transition-all">
                              <i className="fas fa-user text-2xl text-white"></i>
                            </div>
                            <h4 className="text-xl font-bold text-gray-800 mb-2">Consumer</h4>
                            <p className="text-gray-600 text-sm mb-4">
                              Personal loans for individuals, secured or unsecured
                            </p>
                            <div className="text-left mt-4">
                              <p className="text-sm text-gray-700 mb-1"><i className="fas fa-check-circle text-green-500 mr-2"></i> Personal credit assessment</p>
                              <p className="text-sm text-gray-700 mb-1"><i className="fas fa-check-circle text-green-500 mr-2"></i> Income verification</p>
                              <p className="text-sm text-gray-700"><i className="fas fa-check-circle text-green-500 mr-2"></i> Residential status important</p>
                            </div>
                          </button>
                          
                          {/* Commercial Cash Finance */}
                          <button 
                            onClick={() => handleFinanceCategorySelect("Commercial Cash Finance")}
                            className="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-200 rounded-2xl p-6 text-center hover:border-green-400 hover:shadow-lg transition-all duration-300 group"
                          >
                            <div className="inline-block bg-green-500 p-4 rounded-full mb-4 group-hover:bg-green-600 transition-all">
                              <i className="fas fa-money-bill-wave text-2xl text-white"></i>
                            </div>
                            <h4 className="text-xl font-bold text-gray-800 mb-2">Commercial Cash Finance</h4>
                            <p className="text-gray-600 text-sm mb-4">
                              Business loans, lines of credit, and working capital finance
                            </p>
                            <div className="text-left mt-4">
                              <p className="text-sm text-gray-700 mb-1"><i className="fas fa-check-circle text-green-500 mr-2"></i> Business cash flow based</p>
                              <p className="text-sm text-gray-700 mb-1"><i className="fas fa-check-circle text-green-500 mr-2"></i> Turnover requirements</p>
                              <p className="text-sm text-gray-700"><i className="fas fa-check-circle text-green-500 mr-2"></i> Financial statements needed</p>
                            </div>
                          </button>
                        </div>
                      </div>
                    )}
                    
                    {/* STEP 2: All Other Questions - identical to previous version */}
                    {formData.financeCategory && (
                      <div className="space-y-6 max-h-[70vh] overflow-y-auto pr-4">
                        {/* Basic Information */}
                        <div className="border-l-4 border-blue-500 pl-4">
                          <h3 className="font-bold text-gray-700 flex items-center">
                            <i className="fas fa-info-circle mr-2 text-blue-500"></i>
                            Basic Information
                          </h3>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              <i className="fas fa-dollar-sign text-green-500 mr-1"></i>
                              Loan Amount
                            </label>
                            <div className="relative">
                              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span className="text-gray-500">$</span>
                              </div>
                              <input 
                                type="number" 
                                className="pl-8 w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                placeholder="e.g., 50,000" 
                                value={formData.loanAmount} 
                                onChange={e => update("loanAmount", e.target.value)} 
                              />
                            </div>
                          </div>
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              <i className="fas fa-calendar-alt text-blue-500 mr-1"></i>
                              Loan Term (months)
                            </label>
                            <select 
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              value={formData.loanTerm} 
                              onChange={e => update("loanTerm", e.target.value)}
                            >
                              <option value="12">12 months</option>
                              <option value="24">24 months</option>
                              <option value="36">36 months</option>
                              <option value="48">48 months</option>
                              <option value="60">60 months</option>
                              <option value="72">72 months</option>
                              <option value="84">84 months</option>
                            </select>
                          </div>
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              <i className="fas fa-balloon text-purple-500 mr-1"></i>
                              Balloon Payment (%)
                            </label>
                            <select 
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              value={formData.balloonPercent} 
                              onChange={e => update("balloonPercent", e.target.value)}
                            >
                              <option value="0">0%</option>
                              <option value="5">5%</option>
                              <option value="10">10%</option>
                              <option value="15">15%</option>
                              <option value="20">20%</option>
                              <option value="25">25%</option>
                              <option value="30">30%</option>
                              <option value="35">35%</option>
                              <option value="40">40%</option>
                            </select>
                          </div>
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              <i className="fas fa-percentage text-green-500 mr-1"></i>
                              Deposit Percentage
                            </label>
                            <div className="relative">
                              <input 
                                type="number" 
                                min="0" 
                                max="100" 
                                step="0.1"
                                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                placeholder="Enter deposit %" 
                                value={formData.depositPercent} 
                                onChange={e => update("depositPercent", e.target.value)} 
                              />
                              <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span className="text-gray-500">%</span>
                              </div>
                            </div>
                          </div>
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              <i className="fas fa-chart-bar text-blue-500 mr-1"></i>
                              Credit Score Type
                            </label>
                            <select 
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              value={formData.creditScoreType} 
                              onChange={e => update("creditScoreType", e.target.value)}
                            >
                              <option value="N/A">N/A (No credit score available)</option>
                              <option value="Comprehensive">Comprehensive (Equifax)</option>
                              <option value="Veda">Veda Score</option>
                              <option value="CCR">CCR Score</option>
                              <option value="Both">Both Comprehensive & Veda</option>
                            </select>
                          </div>
                        </div>
                        
                        {/* Credit Score Details */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          {(formData.creditScoreType === "Comprehensive" || formData.creditScoreType === "Both") && (
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Comprehensive (Equifax) Score
                              </label>
                              <input 
                                type="number" 
                                min="0" 
                                max="1200"
                                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                placeholder="Equifax score" 
                                value={formData.creditScoreComprehensive} 
                                onChange={e => update("creditScoreComprehensive", e.target.value)} 
                              />
                            </div>
                          )}
                          
                          {(formData.creditScoreType === "Veda" || formData.creditScoreType === "Both") && (
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Veda Credit Score
                              </label>
                              <input 
                                type="number" 
                                min="0" 
                                max="1200"
                                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                placeholder="Veda score" 
                                value={formData.creditScoreVeda} 
                                onChange={e => update("creditScoreVeda", e.target.value)} 
                              />
                            </div>
                          )}
                          
                          {(formData.creditScoreType === "CCR") && (
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                CCR Score
                              </label>
                              <input 
                                type="number" 
                                min="0" 
                                max="1200"
                                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                placeholder="CCR score" 
                                value={formData.ccrScore} 
                                onChange={e => update("ccrScore", e.target.value)} 
                              />
                            </div>
                          )}
                        </div>
                        
                        {/* Business Information Section */}
                        {shouldShowBusinessSection() && (
                          <>
                            <div className="border-l-4 border-purple-500 pl-4">
                              <h3 className="font-bold text-gray-700 flex items-center">
                                <i className="fas fa-building mr-2 text-purple-500"></i>
                                Business Information
                              </h3>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  Entity Type
                                </label>
                                <select 
                                  className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                  value={formData.entityType} 
                                  onChange={e => update("entityType", e.target.value)}
                                >
                                  <option value="PtyLtd">Pty Ltd</option>
                                  <option value="SoleTrader">Sole Trader</option>
                                  <option value="Trust">Trust</option>
                                </select>
                              </div>
                              
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  ABN Age
                                </label>
                                <select 
                                  className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                  value={formData.abnAge} 
                                  onChange={e => update("abnAge", e.target.value)}
                                >
                                  <option value="No">No</option>
                                  <option value="New-3 months">New-3 months</option>
                                  <option value="3-6 months">3-6 months</option>
                                  <option value="6-12 months">6-12 months</option>
                                  <option value="12-18 months">12-18 months</option>
                                  <option value="18-24 months">18-24 months</option>
                                  <option value="24 months +">24 months +</option>
                                </select>
                              </div>
                              
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  GST Registration Age
                                </label>
                                <select 
                                  className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                  value={formData.gstAge} 
                                  onChange={e => update("gstAge", e.target.value)}
                                >
                                  <option value="No">No</option>
                                  <option value="New-3 months">New-3 months</option>
                                  <option value="3-6 months">3-6 months</option>
                                  <option value="6-12 months">6-12 months</option>
                                  <option value="12-18 months">12-18 months</option>
                                  <option value="18-24 months">18-24 months</option>
                                  <option value="24 months +">24 months +</option>
                                </select>
                              </div>
                              
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  Monthly Turnover ($)
                                </label>
                                <div className="relative">
                                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span className="text-gray-500">$</span>
                                  </div>
                                  <input 
                                    type="number" 
                                    className="pl-8 w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                    placeholder="Monthly turnover" 
                                    value={formData.businessTurnoverPM} 
                                    onChange={e => update("businessTurnoverPM", e.target.value)} 
                                  />
                                </div>
                              </div>
                              
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  ATO Documents Available
                                </label>
                                <select 
                                  className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                  value={formData.provideATODocuments} 
                                  onChange={e => update("provideATODocuments", e.target.value)}
                                >
                                  <option value="No">No</option>
                                  <option value="Yes">Yes</option>
                                </select>
                              </div>
                            </div>
                          </>
                        )}
                        
                        {/* Consumer Information Section */}
                        {shouldShowConsumerSection() && (
                          <>
                            <div className="border-l-4 border-green-500 pl-4">
                              <h3 className="font-bold text-gray-700 flex items-center">
                                <i className="fas fa-user mr-2 text-green-500"></i>
                                Personal Information
                              </h3>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  Monthly Income ($)
                                </label>
                                <div className="relative">
                                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span className="text-gray-500">$</span>
                                  </div>
                                  <input 
                                    type="number" 
                                    className="pl-8 w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                    placeholder="Monthly income" 
                                    value={formData.monthlyIncome} 
                                    onChange={e => update("monthlyIncome", e.target.value)} 
                                  />
                                </div>
                              </div>
                              
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  Employment Type
                                </label>
                                <select 
                                  className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                  value={formData.employmentType} 
                                  onChange={e => update("employmentType", e.target.value)}
                                >
                                  <option value="Full-time">Full-time</option>
                                  <option value="Part-time">Part-time</option>
                                  <option value="Casual">Casual</option>
                                  <option value="Self-employed">Self-employed</option>
                                </select>
                              </div>
                            </div>
                          </>
                        )}
                        
                        {/* Asset Information Section */}
                        <div className="border-l-4 border-yellow-500 pl-4">
                          <h3 className="font-bold text-gray-700 flex items-center">
                            <i className="fas fa-car mr-2 text-yellow-500"></i>
                            Asset Information
                          </h3>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              Asset Type
                            </label>
                            <select 
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              value={formData.assetType} 
                              onChange={e => update("assetType", e.target.value)}
                            >
                              <option value="Asset_Car">Car / Van</option>
                              <option value="Asset_Truck">Truck</option>
                              <option value="Asset_Trailer">Trailer</option>
                              <option value="Asset_Equipment">Equipment</option>
                              <option value="Asset_PrimeMover">Prime Mover</option>
                              <option value="Asset_Other">Other</option>
                            </select>
                          </div>
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              Asset Age (years)
                            </label>
                            <select 
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              value={formData.assetAge} 
                              onChange={e => update("assetAge", e.target.value)}
                            >
                              <option value="0">New (0 years)</option>
                              <option value="1">1 year</option>
                              <option value="2">2 years</option>
                              <option value="3">3 years</option>
                              <option value="4">4 years</option>
                              <option value="5">5 years</option>
                              <option value="6">6 years</option>
                              <option value="7">7 years</option>
                              <option value="8">8 years</option>
                              <option value="9">9 years</option>
                              <option value="10">10 years</option>
                              <option value="11">11 years</option>
                              <option value="12">12 years</option>
                              <option value="13">13 years</option>
                              <option value="14">14 years</option>
                              <option value="15">15 years</option>
                              <option value="15+">15+ years</option>
                            </select>
                          </div>
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              Asset Value (for LVR)
                            </label>
                            <div className="relative">
                              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span className="text-gray-500">$</span>
                              </div>
                              <input 
                                type="number" 
                                className="pl-8 w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                placeholder="Asset purchase price" 
                                value={formData.assetValue} 
                                onChange={e => update("assetValue", e.target.value)} 
                              />
                            </div>
                          </div>
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              Private Sale?
                            </label>
                            <select 
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              value={formData.privateSale} 
                              onChange={e => update("privateSale", e.target.value)}
                            >
                              <option value="No">No</option>
                              <option value="Yes">Yes</option>
                            </select>
                          </div>
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              Refinance?
                            </label>
                            <select 
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              value={formData.refinance} 
                              onChange={e => update("refinance", e.target.value)}
                            >
                              <option value="No">No</option>
                              <option value="Yes">Yes</option>
                            </select>
                          </div>
                        </div>
                        
                        {/* Additional Information Section */}
                        <div className="border-l-4 border-red-500 pl-4">
                          <h3 className="font-bold text-gray-700 flex items-center">
                            <i className="fas fa-info-circle mr-2 text-red-500"></i>
                            Additional Information
                          </h3>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              Residential Proof
                            </label>
                            <select 
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              value={formData.residentialProof} 
                              onChange={e => update("residentialProof", e.target.value)}
                            >
                              <option value="No">No</option>
                              <option value="6 months">6 months</option>
                              <option value="12 months">12 months</option>
                              <option value="24 months +">24 months +</option>
                            </select>
                          </div>
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              Bank Statements Available
                            </label>
                            <select 
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              value={formData.provideBankStatements} 
                              onChange={e => update("provideBankStatements", e.target.value)}
                            >
                              <option value="No">No</option>
                              <option value="Yes">Yes</option>
                            </select>
                          </div>
                          
                          {formData.provideBankStatements === "Yes" && (
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Months of Bank Statements
                              </label>
                              <select 
                                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                                value={formData.bankStatementsMonths} 
                                onChange={e => update("bankStatementsMonths", e.target.value)}
                              >
                                <option value="3">3 months</option>
                                <option value="6">6 months</option>
                                <option value="12">12 months</option>
                                <option value="24">24 months</option>
                              </select>
                            </div>
                          )}
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              Comparable Credit History
                            </label>
                            <select 
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              value={formData.comparableCredit} 
                              onChange={e => update("comparableCredit", e.target.value)}
                            >
                              <option value="No">No</option>
                              <option value="Yes">Yes</option>
                            </select>
                          </div>
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              Dishonours (Last 90 days)
                            </label>
                            <input 
                              type="number" 
                              min="0"
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              placeholder="Number of dishonours" 
                              value={formData.dishonoursLast90D} 
                              onChange={e => update("dishonoursLast90D", e.target.value)} 
                            />
                          </div>
                          
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              Payday Loans
                            </label>
                            <select 
                              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50" 
                              value={formData.hasPaydayLoans} 
                              onChange={e => update("hasPaydayLoans", e.target.value)}
                            >
                              <option value="No">No</option>
                              <option value="Yes">Yes</option>
                            </select>
                          </div>
                        </div>
                        
                        {/* Checkbox Options */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div className="flex items-center space-x-3">
                            <label className="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200 w-full">
                              <input 
                                type="checkbox" 
                                className="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                                checked={formData.isHomeOwner === "Yes"} 
                                onChange={e => update("isHomeOwner", e.target.checked ? "Yes" : "No")} 
                              />
                              <span className="font-medium text-gray-700">
                                <i className="fas fa-house-user text-blue-500 mr-2"></i>
                                Home Owner
                              </span>
                            </label>
                          </div>
                          
                          <div className="flex items-center space-x-3">
                            <label className="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200 w-full">
                              <input 
                                type="checkbox" 
                                className="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                                checked={formData.isAssetBacked === "Yes"} 
                                onChange={e => update("isAssetBacked", e.target.checked ? "Yes" : "No")} 
                              />
                              <span className="font-medium text-gray-700">
                                <i className="fas fa-landmark text-green-500 mr-2"></i>
                                Asset Backed
                              </span>
                            </label>
                          </div>
                        </div>
                        
                        {/* Action Buttons */}
                        <div className="pt-6 border-t border-gray-200">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button 
                              onClick={calculateMatch} 
                              disabled={lenders.length === 0 || loading}
                              className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-6 rounded-xl font-bold text-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl flex items-center justify-center"
                            >
                              {loading ? (
                                <>
                                  <i className="fas fa-spinner fa-spin mr-3"></i>
                                  Processing...
                                </>
                              ) : (
                                <>
                                  <i className="fas fa-rocket mr-3"></i>
                                  Find Qualified Lenders
                                </>
                              )}
                            </button>
                            
                            <button 
                              onClick={resetForm}
                              type="button"
                              className="w-full bg-gradient-to-r from-gray-600 to-gray-700 text-white py-4 px-6 rounded-xl font-bold text-lg hover:from-gray-700 hover:to-gray-800 transition-all duration-300 shadow-lg hover:shadow-xl flex items-center justify-center"
                            >
                              <i className="fas fa-redo mr-3"></i>
                              Reset Form
                            </button>
                          </div>
                          
                          {lenders.length === 0 && !loading && (
                            <p className="text-center text-red-500 mt-2 text-sm">
                              <i className="fas fa-exclamation-triangle mr-1"></i>
                              No lenders loaded. Please check connection.
                            </p>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
              
              {/* Sidebar */}
              <div className="lg:col-span-1">
                <div className="sticky top-8 space-y-6">
                  <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-2xl p-6 shadow-deep">
                    <div className="flex items-center mb-4">
                      <div className="bg-white/20 p-3 rounded-xl mr-4">
                        <i className="fas fa-lightbulb text-2xl"></i>
                      </div>
                      <h3 className="text-xl font-bold">Category Guide</h3>
                    </div>
                    <ul className="space-y-3">
                      <li className="flex items-start">
                        <i className="fas fa-truck-loading text-blue-300 mr-3 mt-1"></i>
                        <div>
                          <span className="font-medium">Commercial Asset:</span>
                          <p className="text-sm text-blue-100">Business asset finance - vehicles, equipment</p>
                        </div>
                      </li>
                      <li className="flex items-start">
                        <i className="fas fa-user text-purple-300 mr-3 mt-1"></i>
                        <div>
                          <span className="font-medium">Consumer:</span>
                          <p className="text-sm text-blue-100">Personal loans - cars, caravans, personal use</p>
                        </div>
                      </li>
                      <li className="flex items-start">
                        <i className="fas fa-money-bill-wave text-green-300 mr-3 mt-1"></i>
                        <div>
                          <span className="font-medium">Commercial Cash:</span>
                          <p className="text-sm text-blue-100">Working capital, business loans, lines of credit</p>
                        </div>
                      </li>
                    </ul>
                  </div>
                  
                  <div className="bg-white rounded-2xl p-6 shadow-deep">
                    <h3 className="font-bold text-gray-800 mb-4 flex items-center">
                      <i className="fas fa-tachometer-alt text-blue-500 mr-3"></i>
                      System Status
                    </h3>
                    <div className="space-y-4">
                      <div>
                        <div className="flex justify-between mb-1">
                          <span className="text-sm font-medium text-gray-700">Lender Database</span>
                          <span className="text-sm font-bold text-blue-600">{lenders.length} products</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div 
                            className="bg-green-500 h-2 rounded-full" 
                            style={{ width: `${Math.min(100, (lenders.length / 200) * 100)}%` }}
                          ></div>
                        </div>
                      </div>
                      
                      <div>
                        <div className="flex justify-between mb-1">
                          <span className="text-sm font-medium text-gray-700">Hard Stop Checks</span>
                          <span className="text-sm font-bold text-red-600">Active</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div className="bg-red-500 h-2 rounded-full w-full"></div>
                        </div>
                      </div>
                      
                      {formData.financeCategory && (
                        <div>
                          <div className="flex justify-between mb-1">
                            <span className="text-sm font-medium text-gray-700">Selected Category</span>
                            <span className="text-sm font-bold text-purple-600">{formData.financeCategory}</span>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-2">
                            <div className="bg-purple-500 h-2 rounded-full w-full"></div>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    {loading && (
                      <div className="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                        <div className="flex items-center">
                          <i className="fas fa-sync-alt fa-spin text-blue-500 mr-3"></i>
                          <span className="font-medium text-blue-800">Loading lender data...</span>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <div className="bg-white rounded-2xl p-6 shadow-deep">
                    <h3 className="font-bold text-gray-800 mb-4 flex items-center">
                      <i className="fas fa-calculator text-purple-500 mr-3"></i>
                      LVR Calculator
                    </h3>
                    <div className="space-y-3">
                      <div className="text-sm">
                        <p className="text-gray-500 mb-1">Loan: {formData.loanAmount || '0'}</p>
                        <p className="text-gray-500 mb-1">Asset Value: {formData.assetValue || '0'}</p>
                        <div className="mt-2 pt-2 border-t border-gray-200">
                          <p className="font-bold text-green-600">
                            LVR: {formData.loanAmount && formData.assetValue ? 
                              calculateLVR(formData.loanAmount, formData.assetValue).toFixed(1) + '%' : 
                              'N/A'}
                          </p>
                          <p className="text-xs text-gray-500">
                            Loan-to-Value Ratio
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* ---------- QUALIFIED LENDERS ---------- */}
            {results && (
              <div className="mt-8">
                <div className="bg-white rounded-2xl p-6 mb-6 shadow-deep">
                  <div className="flex flex-col md:flex-row justify-between items-center">
                    <div>
                      <h2 className="text-2xl font-bold text-gray-800">Qualifying Lenders</h2>
                      <p className="text-gray-600">Sorted by match score (higher = better)</p>
                    </div>
                    <div className="mt-4 md:mt-0 bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-3 rounded-xl font-bold text-lg">
                      <i className="fas fa-check-circle mr-2"></i>
                      {results.length} Qualified Lender{results.length !== 1 ? 's' : ''}
                    </div>
                  </div>
                </div>
                
                {results.length > 0 ? (
                  <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    {results.map((lender, idx) => (
                      <div key={idx} className="bg-white rounded-2xl p-6 shadow-soft border border-gray-100 hover:shadow-md transition-all duration-300 hover:border-blue-100">
                        <div className="flex justify-between items-start mb-4">
                          <div>
                            <h3 className="text-xl font-bold text-gray-900">{lender.Lender_Name}</h3>
                            <p className="text-lg text-gray-600">{lender.Product}</p>
                            <div className="flex items-center mt-2 space-x-2">
                              <span className="px-3 py-1 rounded-full text-sm font-semibold bg-gradient-to-r from-green-100 to-green-50 text-green-800 border border-green-200">
                                <i className="fas fa-check mr-2"></i>
                                Qualified
                              </span>
                              <span className="score-badge">
                                <i className="fas fa-star mr-1" style={{ color: '#FFD700' }}></i>
                                Score: {lender.score}
                              </span>
                            </div>
                          </div>
                        </div>

                        <div className="space-y-3 mb-4">
                          <div className="bg-gray-50 p-3 rounded-lg">
                            <p className="text-xs text-gray-500 uppercase font-semibold">Loan Range</p>
                            <p className="text-sm font-semibold text-gray-900">{lender.Min_Loan || '0'} - {lender.Max_Loan || 'No Max'}</p>
                          </div>
                          <div className="bg-gray-50 p-3 rounded-lg">
                            <p className="text-xs text-gray-500 uppercase font-semibold">Term</p>
                            <p className="text-sm font-semibold text-gray-900">{lender.Max_Loan_Length || '60'} months</p>
                          </div>
                          <div className="bg-gray-50 p-3 rounded-lg">
                            <p className="text-xs text-gray-500 uppercase font-semibold">Category</p>
                            <p className="text-sm font-semibold text-gray-900">{lender.Finance_Category}</p>
                          </div>
                          <div className="bg-gray-50 p-3 rounded-lg">
                            <p className="text-xs text-gray-500 uppercase font-semibold">ABN Age Required</p>
                            <p className="text-sm font-semibold text-gray-900">{lender.Min_ABN_Mths || '0'} months</p>
                          </div>
                          {lender.totalBrokerageFee > 0 && (
                            <div className="bg-purple-50 p-3 rounded-lg border border-purple-100">
                              <p className="text-xs text-purple-600 uppercase font-semibold">Estimated Brokerage</p>
                              <p className="text-sm font-semibold text-purple-900">${lender.totalBrokerageFee?.toLocaleString()}</p>
                            </div>
                          )}
                        </div>

                        {lender.Special_Notes && (
                          <div className="text-sm text-gray-600 p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <i className="fas fa-info-circle text-blue-500 mr-2"></i>
                            {lender.Special_Notes.substring(0, 100)}{lender.Special_Notes.length > 100 ? '...' : ''}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-2xl p-8 border border-yellow-100 shadow-deep">
                    <div className="text-center">
                      <div className="inline-block bg-yellow-100 p-4 rounded-full mb-4">
                        <i className="fas fa-search text-4xl text-yellow-600"></i>
                      </div>
                      <h3 className="text-2xl font-bold text-yellow-800 mb-2">No Matches Found</h3>
                      <p className="text-yellow-700 mb-6 max-w-2xl mx-auto">
                        No lenders matched all your requirements. Try adjusting your criteria.
                      </p>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ---------- EXCLUDED LENDERS SECTION ---------- */}
            {excludedResults && excludedResults.length > 0 && (
              <div className="mt-10">
                <div 
                  className="bg-white rounded-2xl p-6 shadow-deep cursor-pointer hover:shadow-lg transition-all"
                  onClick={() => setShowExcluded(!showExcluded)}
                >
                  <div className="flex justify-between items-center">
                    <div className="flex items-center space-x-3">
                      <div className="bg-red-100 p-3 rounded-xl">
                        <i className="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                      </div>
                      <div>
                        <h3 className="text-xl font-bold text-gray-800">
                          Why Others Didn't Qualify ({excludedResults.length} lenders)
                        </h3>
                        <p className="text-sm text-gray-600">
                          Click to {showExcluded ? 'hide' : 'show'} exclusion reasons
                        </p>
                      </div>
                    </div>
                    <i className={`fas fa-chevron-${showExcluded ? 'up' : 'down'} text-gray-500 text-xl`}></i>
                  </div>
                </div>

                {showExcluded && (
                  <div className="mt-4 grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    {excludedResults.map((lender, idx) => (
                      <div key={idx} className="bg-white rounded-2xl p-6 shadow-soft border border-red-200 excluded-card">
                        <div className="flex justify-between items-start mb-3">
                          <div>
                            <h4 className="text-lg font-bold text-gray-900">{lender.Lender_Name}</h4>
                            <p className="text-md text-gray-700">{lender.Product}</p>
                          </div>
                          <span className="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800 border border-red-300">
                            Excluded
                          </span>
                        </div>
                        <div className="space-y-2">
                          <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Exclusion reasons</p>
                          <ul className="list-disc list-inside text-sm text-red-700 bg-red-50 p-3 rounded-lg">
                            {lender.exclusionReasons.map((reason, i) => (
                              <li key={i} className="mb-1">{reason}</li>
                            ))}
                          </ul>
                          {lender.Special_Notes && (
                            <div className="text-xs text-gray-600 mt-2 p-2 bg-gray-50 rounded border border-gray-200">
                              <span className="font-semibold">Note:</span> {lender.Special_Notes.substring(0, 120)}...
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* Footer */}
            <div className="mt-12 pt-8 border-t border-gray-200 text-center text-gray-500 text-sm">
              <p>Beaver Match Pro v4.4 {new Date().getFullYear()} Finance Broker Tools</p>
              <p className="mt-1">Database: {lenders.length} lender products • Hard Stop Checks: Active • Scoring: Active • Exclusion Tracking: Active</p>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<LenderMatchingApp />);
  </script>
</body>
</html>