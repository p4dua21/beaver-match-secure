<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Beaver Match Pro v2 | Lender Decision Engine</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    function LenderMatchingApp() {
      const [formData, setFormData] = useState({
        loanAmount: "",
        lendeeAge: "25+",
        creditScore: "",
        entityType: "PtyLtd",
        abnAge: "N/A - 3 months",
        gstRegistered: "Yes",
        assetType: "Asset_Car",
        assetAge: "0",
        loanTerm: "60",
        balloonPercent: "0",
        depositPercent: "0", // NEW FIELD
        residentialProof: "No",
        isHomeOwner: "No",
        isAssetBacked: "No",
        provideBankStatements: "Yes"
      });

      const [lenders, setLenders] = useState([]);
      const [results, setResults] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      useEffect(() => {
        loadSheets();
      }, []);

      async function loadSheets() {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch('/api/get-lenders');
          
          if (!response.ok) {
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          if (!data.values || data.values.length === 0) {
            throw new Error("No data returned from server");
          }

          const headers = data.values[0];
          const parsed = [];

          for (let i = 1; i < data.values.length; i++) {
            const row = data.values[i];
            let obj = {};
            headers.forEach((header, idx) => {
              if (header && header.trim()) {
                obj[header.trim()] = (row[idx] || '').toString().trim();
              }
            });
            if (obj.Lender_Name && obj.Lender_Name.length > 0) {
              parsed.push(obj);
            }
          }

          setLenders(parsed);
        } catch (err) {
          console.error("Load error:", err);
          setError(err.message);
        }
        setLoading(false);
      }

      // --- HELPER LOGIC FOR DEPOSIT HARDSTOP ---
      function parseDepositRequirement(reqString) {
        if (!reqString) return 0;
        const str = reqString.toLowerCase();
        
        if (str.includes("doesn't qualify")) return 999; // High hurdle to force exclusion
        
        // Matches the first number found before a % sign (e.g., "20% Deposit" -> 20)
        const match = str.match(/(\d+)%/);
        return match ? parseInt(match[1]) : 0;
      }

      function meetsMinCreditScore(userScore, lenderRequirement) {
        if (!lenderRequirement) return true;
        const score = parseInt(userScore);
        const req = lenderRequirement.toLowerCase();
        if (!isNaN(parseInt(lenderRequirement))) {
          return score >= parseInt(lenderRequirement);
        }
        if (req.includes("good") || req === "satisfactory") return score >= 650;
        if (req.includes("solid")) return score >= 600;
        if (req.includes("ccr tiers")) return score >= 500;
        return true;
      }

      function meetsAgeRestriction(userAge, restriction) {
        if (!restriction || restriction === "None") return true;
        const userIs25Plus = userAge === "25+";
        if (restriction.includes("25")) return userIs25Plus;
        return true;
      }

      function parseABNMonths(abnSelection) {
        const mapping = {
          "N/A - 3 months": 0, "3-6": 3, "6-12": 6, "1-2 year": 12, "2-3 year": 24, "3 + year": 36
        };
        return mapping[abnSelection] || 0;
      }

      function meetsEntityRequirement(userEntity, lender) {
        if (lender.Pty_Ltd_Only === "Yes" && userEntity !== "PtyLtd") return false;
        if (lender.Sole_Trader_Only === "Yes" && userEntity !== "SoleTrader") return false;
        return true;
      }

      function meetsResidentialRequirement(userProof, lenderRequirement) {
        if (!lenderRequirement || lenderRequirement === "No") return true;
        if (userProof === "No") return false;
        const userMonths = { "No": 0, "6 months": 6, "12 months": 12, "24 months +": 24 }[userProof] || 0;
        const req = lenderRequirement.toString().toLowerCase();
        let requiredMonths = 0;
        if (req.includes("24") || req.includes("2 year")) requiredMonths = 24;
        else if (req.includes("12") || req.includes("1 year")) requiredMonths = 12;
        else if (req.includes("6")) requiredMonths = 6;
        else if (req === "yes" || req === "required") requiredMonths = 6;
        return userMonths >= requiredMonths;
      }

      function calculateMatch() {
        if (!formData.loanAmount) {
          alert("Please enter a loan amount");
          return;
        }

        const scored = lenders.map(l => {
          let score = 60;
          let reasons = [];
          let isExcluded = false;

          // --- DEPOSIT HARDSTOP LOGIC ---
          if (formData.isAssetBacked === "No") {
            const reqString = l.If_Non_Asset_Backed || "";
            const minRequiredDeposit = parseDepositRequirement(reqString);
            const userDeposit = parseFloat(formData.depositPercent) || 0;

            if (reqString.toLowerCase().includes("doesn't qualify")) {
              isExcluded = true;
            } else if (userDeposit < minRequiredDeposit) {
              isExcluded = true;
            }
          }

          if (!meetsEntityRequirement(formData.entityType, l)) isExcluded = true;

          const loanAmt = parseFloat(formData.loanAmount);
          if (l.Min_Loan_Amount && loanAmt < parseFloat(l.Min_Loan_Amount)) isExcluded = true;
          if (l.Max_Loan_Amount && loanAmt > parseFloat(l.Max_Loan_Amount)) isExcluded = true;

          if (!meetsAgeRestriction(formData.lendeeAge, l.Age_Restrictions)) isExcluded = true;
          if (!meetsMinCreditScore(formData.creditScore, l.Equifax_Credit_Score)) isExcluded = true;

          if (l.Age_Asset_Limit) {
            const assetAge = formData.assetAge === "15+" ? 16 : parseInt(formData.assetAge);
            if (assetAge > parseInt(l.Age_Asset_Limit)) isExcluded = true;
          }

          if (l.Max_Asset_Age_End_of_Term) {
            const currentAssetAge = formData.assetAge === "15+" ? 16 : parseInt(formData.assetAge);
            const loanTermYears = parseInt(formData.loanTerm) / 12;
            if ((currentAssetAge + loanTermYears) > parseInt(l.Max_Asset_Age_End_of_Term)) isExcluded = true;
          }

          if (l.Requires_GST_Registration === "Yes" && formData.gstRegistered !== "Yes") isExcluded = true;
          if (l.Min_ABN_Age_Months && parseABNMonths(formData.abnAge) < parseInt(l.Min_ABN_Age_Months)) isExcluded = true;
          const balloonPct = parseFloat(formData.balloonPercent);
          if (l.Balloon_Max && balloonPct > parseFloat(l.Balloon_Max)) isExcluded = true;

          if (!meetsResidentialRequirement(formData.residentialProof, l.Residential_Required)) isExcluded = true;
          if (l.Need_Bank_Statements === "Yes" && formData.provideBankStatements !== "Yes") isExcluded = true;

          // Scoring
          if (formData.isAssetBacked === "Yes") { score += 10; reasons.push("Asset-backed"); }
          if (parseInt(formData.creditScore) >= 700) { score += 10; reasons.push("Strong credit"); }

          return { ...l, finalScore: Math.min(score, 100), reasons, isExcluded };
        })
        .filter(l => !l.isExcluded)
        .sort((a, b) => b.finalScore - a.finalScore);

        setResults(scored);
      }

      const update = (f, v) => setFormData(p => ({ ...p, [f]: v }));

      return (
        <div className="min-h-screen bg-gray-50 py-8 px-4">
          <div className="max-w-4xl mx-auto">
            <div className="text-center mb-8">
              <h1 className="text-4xl font-bold text-red-600 mb-2">Beaver Match Pro</h1>
              <p className="text-gray-600">Lender Decision Engine</p>
            </div>

            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Loan Amount ($)</label>
                  <input type="number" className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500" value={formData.loanAmount} onChange={e => update("loanAmount", e.target.value)} />
                </div>

                {/* NEW DEPOSIT INPUT */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Deposit Paid (%)</label>
                  <input type="number" className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500" placeholder="e.g. 20" value={formData.depositPercent} onChange={e => update("depositPercent", e.target.value)} />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Credit Score</label>
                  <input type="number" className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500" value={formData.creditScore} onChange={e => update("creditScore", e.target.value)} />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Entity Type</label>
                  <select className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500" value={formData.entityType} onChange={e => update("entityType", e.target.value)}>
                    <option value="PtyLtd">Pty Ltd</option>
                    <option value="SoleTrader">Sole Trader</option>
                    <option value="Trust">Trust</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">ABN Age</label>
                  <select className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500" value={formData.abnAge} onChange={e => update("abnAge", e.target.value)}>
                    <option value="N/A - 3 months">N/A - 3 months</option>
                    <option value="3-6">3-6 months</option>
                    <option value="6-12">6-12 months</option>
                    <option value="1-2 year">1-2 years</option>
                    <option value="2-3 year">2-3 years</option>
                    <option value="3 + year">3+ years</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Asset Age</label>
                  <select className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500" value={formData.assetAge} onChange={e => update("assetAge", e.target.value)}>
                    {[...Array(16).keys()].map(i => <option key={i} value={i}>{i} year{i!==1?'s':''}</option>)}
                    <option value="15+">15+ years</option>
                  </select>
                </div>

                <div className="md:col-span-2 flex flex-wrap gap-6 pt-2">
                  <label className="flex items-center space-x-2">
                    <input type="checkbox" className="w-4 h-4 text-red-600" checked={formData.isHomeOwner === "Yes"} onChange={e => update("isHomeOwner", e.target.checked ? "Yes" : "No")} />
                    <span className="text-sm font-medium text-gray-700">Home Owner</span>
                  </label>
                  <label className="flex items-center space-x-2">
                    <input type="checkbox" className="w-4 h-4 text-red-600" checked={formData.isAssetBacked === "Yes"} onChange={e => update("isAssetBacked", e.target.checked ? "Yes" : "No")} />
                    <span className="text-sm font-medium text-gray-700">Asset Backed</span>
                  </label>
                </div>

                <div className="md:col-span-2">
                  <button onClick={calculateMatch} className="w-full bg-red-600 text-white py-3 px-6 rounded-md font-semibold hover:bg-red-700">
                    Find Matching Lenders
                  </button>
                </div>
              </div>
            </div>

            {results && (
              <div className="space-y-4">
                <h2 className="text-2xl font-bold text-gray-900 mb-4">Matching Lenders ({results.length})</h2>
                {results.map((lender, idx) => (
                  <div key={idx} className="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-600">
                    <div className="flex justify-between items-start mb-2">
                      <h3 className="text-xl font-bold text-gray-900">{lender.Lender_Name}</h3>
                      <span className="text-xs font-bold text-gray-400">Score: {lender.finalScore}%</span>
                    </div>
                    <p className="text-sm text-gray-600 italic mb-2">Non-Asset Requirement: {lender.If_Non_Asset_Backed || "N/A"}</p>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div>
                        <p className="text-xs text-gray-500">Loan Range</p>
                        <p className="text-sm font-semibold">${lender.Min_Loan_Amount || '0'} - ${lender.Max_Loan_Amount || 'No Max'}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<LenderMatchingApp />);
  </script>
</body>
</html>